@page "/project-list"
@using Microsoft.AspNetCore.Authorization
@using SkillSnap.Shared.DTOs

@inject HttpClient Http
@inject ILogger<ProjectList> Logger
@inject ISkillSnapApiClient ApiClient
@inject UserContext UserContext
@using Microsoft.AspNetCore.Components.Authorization
@inject AuthenticationStateProvider AuthStateProvider



@attribute [Authorize]

<AuthorizeView>
    <Authorized>
        <p>Welcome, @context.User.Identity!.Name</p>
    </Authorized>
    <NotAuthorized>
        <p>Please log in to view this page.</p>
    </NotAuthorized>
    </AuthorizeView>

<h3>Project List</h3>




@if (projects == null)
{
    if (errorMessage != null)
    {
        <p class="error">@errorMessage</p>
    }
    <div class="project-placeholder-list">
        @for (int i = 0; i < 3; i++)
        {
            <div class="project-placeholder">
                <div class="placeholder-title">Loading project title...</div>
                <div class="placeholder-description">Loading project description...</div>
            </div>
        }
    </div>
}
else if (!projects.Any())
{
    <p>No projects found.</p>
}
else
{
    <ul class="project-list">
        @foreach (var project in projects)
        {
            <li class="project-item" @onclick="@(() => NavigateToDetail(project.Id.ToString()))">
                <div class="project-content">
                    <strong>@project.Title</strong><br />
                    <span>@project.Description</span>
                </div>
            </li>
        }
    </ul>
}

<button class="btn btn-success mb-3" @onclick="ShowCreateForm">+ Add Project</button>
<button class="btn btn-primary mb-3 ms-2" @onclick="ShowAttachForm">+ Attach Existing Project</button>
<button class="btn btn-danger mb-3 ms-2" @onclick="RemoveLastProject">- Remove Last Project</button>

@if (isCreatingProject)
{
    <EditForm Model="newProject" OnValidSubmit="SubmitNewProject">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <label class="form-label">Title</label>
            <InputText class="form-control" @bind-Value="newProject.Title" />
        </div>

        <div class="mb-3">
            <label class="form-label">Description</label>
            <InputTextArea class="form-control" @bind-Value="newProject.Description" />
        </div>

        <div class="mb-3">
            <label class="form-label">Image URL</label>
            <InputText class="form-control" @bind-Value="newProject.ImageUrl" />
        </div>

        <button type="submit" class="btn btn-success me-2">ðŸ’¾ Save</button>
        <button type="button" class="btn btn-secondary" @onclick="CancelCreate">âœ– Cancel</button>
    </EditForm>
}

@if (isAttachingProject)
{
    <select @bind="selectedProjectId" class="form-select">
        <option disabled value="">-- Select a project --</option>
        @foreach (var project in availableProjects)
        {
            <option selected="selected" value="@project.Id">@project.Title</option>
        }
    </select>
    <button class="btn btn-success me-2" @onclick="AttachProject">Attach</button>
    <button class="btn btn-secondary" @onclick="CancelAttach">Cancel</button>
}
@code {


    @inject NavigationManager NavigationManager
    private List<ProjectDto>? projects;
    private string? errorMessage;
    private bool isCreatingProject = false;

    private bool isAttachingProject = false;

    private List<ProjectDto> availableProjects = new();

    private ProjectDto newProject = new ProjectDto()
    {
        Title = string.Empty,
        Description = string.Empty,
        ImageUrl = string.Empty
    };

    private string? selectedProjectId;

    protected override async Task OnInitializedAsync()
    {
        var portfolioId = UserContext.CurrentPortfolioUser?.Id;
        if (portfolioId == null)
        {
            errorMessage = "No portfolio profile found. Please create your profile first.";
            return;
        }

        try
        {
            projects = (await ApiClient.GetUserProjectsAsync())?.ToList();
            var allProjects = await ApiClient.GetAllProjectsAsync();
            var existingIds = projects?.Select(p => p.Id).ToHashSet();
            if(existingIds == null){
                Logger.LogError("Error trying to get existing projects.");
                throw new Exception("Error trying to get existing projects.");
            }
            availableProjects = allProjects.Where(p => !existingIds.Contains(p.Id)).ToList();

        }
        catch (Exception ex)
        {
            errorMessage = "Error loading projects. Please try again later.";
            Logger.LogError($"Error loading projects: {ex.Message}");
        }
    }

    private void NavigateToDetail(string projectId)
    {
        NavigationManager.NavigateTo($"/project-detail/{projectId}");
    }

    /*private async Task AddProject()
    {
    var newProject = new ProjectDto
    {
    Title = $"New Project {DateTime.Now:HHmmss}",
    Description = "This is a newly added project.",
    ImageUrl = "https://via.placeholder.com/150"

    };

    try
    {
    await ApiClient.CreateProjectAsync(newProject);
    projects = (await ApiClient.GetUserProjectsAsync())?.ToList();
    }
    catch (Exception ex)
    {
    errorMessage = "Error adding project.";
    Logger.LogError($"Error adding project: {ex.Message}");
    }
    }*/

    /// <summary>
    ///
    /// </summary>
    /// <returns></returns>
    private async Task RemoveLastProject()
    {
        var portfolioId = UserContext.CurrentPortfolioUser?.Id;
        if (portfolioId == null)
        {
            errorMessage = "No portfolio profile found. Please create your profile first.";
            return;
        }

        if (projects == null || !projects.Any())
            return;

        var lastProject = projects.Last();
        try
        {
            await ApiClient.DeleteProjectAsync(lastProject.Id.ToString());
            projects.Remove(lastProject);
        }
        catch (Exception ex)
        {
            errorMessage = "Error removing project.";
            Logger.LogError($"Error removing project: {ex.Message}");
        }
    }

    /// <summary>
    ///
    /// </summary>
    private void ShowCreateForm()
    {
        newProject = new ProjectDto()
        {
            Title = string.Empty,
            Description = string.Empty,
            ImageUrl = string.Empty,
            PortfolioUserId = UserContext.CurrentPortfolioUser?.Id ?? 0
        }; // Reset form fields
        isCreatingProject = true;
    }

    private async Task ShowAttachForm()
    {
        var portfolioId = UserContext.CurrentPortfolioUser?.Id;
        if (portfolioId == null)
        {
            errorMessage = "No portfolio profile found. Please create your profile first.";
            return;
        }
        try
        {
            var allProjects = await ApiClient.GetAllProjectsAsync();
            var existingIds = projects?.Select(p => p.Id).ToHashSet() ?? new HashSet<int>();
            availableProjects = allProjects.Where(p => !existingIds.Contains(p.Id)).ToList();
            isAttachingProject = true;
        }
        catch (Exception ex)
        {
            errorMessage = "Error loading available projects.";
            Logger.LogError($"Error loading available projects: {ex.Message}");
        }
    }

    private async Task AttachProject()
    {
        var portfolioId = UserContext.CurrentPortfolioUser?.Id;
        if (portfolioId == null)
        {
            errorMessage = "No portfolio profile found. Please create your profile first.";
            return;
        }

        if (!string.IsNullOrEmpty(selectedProjectId))
        {
            var linkedSuccessfully = await ApiClient.PatchProjectAsync(
                selectedProjectId, portfolioId.Value.ToString(), new ProjectDto { PortfolioUserId = portfolioId.Value,
                Description = string.Empty,
                ImageUrl= string.Empty,Title = string.Empty });

            if (linkedSuccessfully)
            {
                projects = (await ApiClient.GetUserProjectsAsync())?.ToList();
                isAttachingProject = false;
            }
            else
            {
                errorMessage = "Failed to attach project.";
            }
        }
    }
    /// <summary>
    /// Submits the new project for addition
    /// </summary>
    /// <returns></returns>
    private async Task SubmitNewProject()
    {
        var portfolioId = UserContext.CurrentPortfolioUser?.Id;
        if (portfolioId == null)
        {
            errorMessage = "No portfolio profile found. Please create your profile first.";
            return;
        }
        try
        {   
            newProject.PortfolioUserId = portfolioId.Value;
            await ApiClient.CreateProjectAsync(newProject);
            projects = (await ApiClient.GetUserProjectsAsync())?.ToList();
            isCreatingProject = false;
        }
        catch (Exception ex)
        {
            errorMessage = "Error adding project.";
            Logger.LogError($"Error adding project: {ex.Message}");
        }
    }

    /// <summary>
    ///
    /// </summary>
    private void CancelCreate()
    {
        isCreatingProject = false;
    }

    /// <summary>
    /// 
    /// </summary>
    /// <param name="args"></param>
    /// <returns></returns>
    private void CancelAttach()
    {
        isAttachingProject = false;
    }
}

<style>
    .project-list {
        list-style-type: none;
        padding: 0;
    }

    .project-item {
        background-color: #f9f9f9;
        margin-bottom: 0.75rem;
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .project-placeholder-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        align-items: center;
        background-color: #f9f9f9;
        padding: 1.5rem;
        border-radius: 10px;

        margin: 2rem auto;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);

    }

    .project-placeholder {
        background-color: #f1f1f1;
        border-radius: 8px;
        padding: 1rem;
    }

    .placeholder-title,
    .placeholder-description {
        background-color: #e0e0e0;
        height: 1rem;
        border-radius: 4px;
        margin-bottom: 0.5rem;
        width: 80%;
    }

    .placeholder-description {
        width: 60%;
    }

    .error {
        color: red;
        text-align: center;
    }

    .btn {
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-size: 0.9rem;
        cursor: pointer;
    }

    .btn-success {
        background-color: #28a745;
        color: white;
        border: none;
    }

    .btn-danger {
        background-color: #dc3545;
        color: white;
        border: none;
    }

    .btn-success:hover {
        background-color: #218838;
    }

    .btn-danger:hover {
        background-color: #c82333;
    }
</style>