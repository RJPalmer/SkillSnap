@page "/profile-card"
@using Microsoft.AspNetCore.Authorization
@using SkillSnap.Shared.DTOs
@using SkillSnap_Client.Services
@using System.Threading.Tasks
@inject ISkillSnapApiClient ApiClient
@inject ILogger<ProfileCard> Logger
@inject UserContext UserContext
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@attribute [Authorize]

<h3>User Profile</h3>

<AuthorizeView>
    <Authorized>
        @if (UserContext.CurrentPortfolioUser is null)
        {
            <p>Loading profile...</p>

            //TODO: Try to load user profile from API
        }
        else
        {
            <p>Welcome, @UserContext.CurrentPortfolioUser?.Name</p>

            <div class="profile-card">
                <img src="@GetProfileImage()"
                     alt="Profile picture"
                     class="profile-picture" />

                @if (isEditing && editableProfile != null)
                {
                    <div class="edit-form">
                        <label>Name:</label>
                        <input @bind="editableProfile.Name" />

                        <label>Bio:</label>
                        <textarea @bind="editableProfile.Bio"></textarea>

                        <label>Profile Image URL:</label>
                        <input @bind="editableProfile.ProfileImageUrl" />

                        <button @onclick="SaveProfile">Save</button>
                        <button @onclick="CancelEdit">Cancel</button>
                    </div>
                }
                else
                {
                    <div class="profile-info">
                        <div class="info-row">
                            <strong>Name:</strong>
                            <span>@UserContext.CurrentPortfolioUser?.Name</span>
                        </div>

                        <div class="info-row">
                            <strong>Bio:</strong>
                            <span>@UserContext.CurrentPortfolioUser?.Bio</span>
                        </div>

                        <button @onclick="EnterEditMode">Edit Profile</button>
                    </div>
                }
            </div>
        }
    </Authorized>
    <NotAuthorized>
        <p>Please log in to view this page.</p>
    </NotAuthorized>
</AuthorizeView>

@if (errorMessage != null)
{
    <p class="error">@errorMessage</p>
}

@code {
    private string? errorMessage;
    private bool isEditing = false;
    private PortfolioUserDto? editableProfile;

    /// <summary>
    /// Called when the component is initialized. Loads the user profile.
    ///</summary>

    protected override async Task OnInitializedAsync()
    {
        // Only run initialization if not already loaded
        if (UserContext.CurrentPortfolioUser is null)
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            var portfolioIdClaim = user.FindFirst("portfolioUserId")?.Value;
            if (!String.IsNullOrEmpty(portfolioIdClaim))
            {
                var profile = await ApiClient.GetUserProfileByIdAsync(portfolioIdClaim);
                if (profile != null)
                {
                    UserContext.SetPortfolioUser(profile);
                }
            }
            else
            {
                Logger.LogWarning("No portfolioUserId claim found for authenticated user.");
                //redirect to create profile page could be handled here if desired
                Navigation.NavigateTo("/profile/create");
            }
        }
        await LoadUserProfile();
    }
    private string GetProfileImage()
    {
        return (editableProfile?.ProfileImageUrl ?? UserContext.CurrentPortfolioUser?.ProfileImageUrl)
            ?? "/images/default_picture.jpeg";
    }

    /// <summary>
    /// Loads the user profile from the API if not already loaded.
    /// </summary>
    private async Task LoadUserProfile()
    {
        if(UserContext.CurrentPortfolioUser is null){
            //fetch user profile from API if needed
            try
            {
                // Example API call to fetch user profile
                var userProfile = await ApiClient.GetUserProfileAsync();
                if(userProfile is null)
                {   
                    //user context remains null and unable to load profile
                    errorMessage = "Failed to load user profile.";

                    // If the user is authenticated but we still don't have a PortfolioUser,
                    // forward them to the Create Profile page so they can create one.
                    var authState = await AuthStateProvider.GetAuthenticationStateAsync();
                    var user = authState.User;
                    if (user?.Identity?.IsAuthenticated == true)
                    {
                        var relative = Navigation.ToBaseRelativePath(Navigation.Uri).TrimEnd('/');
                        if (!string.Equals(relative, "profile/create", StringComparison.OrdinalIgnoreCase))
                        {
                            Logger.LogInformation("Authenticated user without PortfolioUser found â€” navigating to /profile/create.");
                            Navigation.NavigateTo("/profile/create");
                            return;
                        }
                    }

                    return;
                }
                UserContext.SetPortfolioUser(userProfile);
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error loading user profile");
                errorMessage = "Error loading user profile.";
            }
        }
    }
    private void EnterEditMode()
    {
        if (UserContext.CurrentPortfolioUser is not null)
        {
            editableProfile = new PortfolioUserDto
            {
                Id = UserContext.CurrentPortfolioUser.Id,
                Name = UserContext.CurrentPortfolioUser.Name,
                Bio = UserContext.CurrentPortfolioUser.Bio,
                ProfileImageUrl = UserContext.CurrentPortfolioUser.ProfileImageUrl
            };

            isEditing = true;
            errorMessage = null;
        }
    }

    private async Task SaveProfile()
    {
        try
        {
            if (editableProfile != null)
            {
                if (string.IsNullOrWhiteSpace(editableProfile.Name))
                {
                    errorMessage = "Name cannot be empty.";
                    return;
                }

                var success = await ApiClient.UpdateUserProfileAsync(
                    editableProfile.Id.ToString(),
                    editableProfile
                );

                if (success)
                {
                    UserContext.SetPortfolioUser(editableProfile);
                    isEditing = false;
                    errorMessage = null;
                }
                else
                {
                    errorMessage = "Failed to update profile.";
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error updating profile");
            errorMessage = "Error updating profile.";
        }
    }

    private void CancelEdit()
    {
        isEditing = false;
        editableProfile = null;
        errorMessage = null;
    }
}

<style>
    .profile-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        background-color: #f9f9f9;
        padding: 1.5rem;
        border-radius: 10px;
        max-width: 400px;
        margin: 2rem auto;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .profile-picture {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        object-fit: cover;
        margin-bottom: 1rem;
    }

    .profile-info {
        width: 100%;
        text-align: left;
    }

    .info-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
    }

    strong {
        width: 80px;
    }

    .error {
        text-align: center;
        color: red;
        margin-top: 1rem;
    }

    .edit-form {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        width: 100%;
    }
</style>