@page "/skill-client"
@using Microsoft.AspNetCore.Authorization
@using SkillSnap.Shared.DTOs
@inject ILogger<SkillClient> Logger
@inject UserContext UserContext
@inject ISkillSnapApiClient ApiClient

@attribute [Authorize]

<h3>Skill Client Page</h3>

<AuthorizeView>
    <Authorized>
        <p>Welcome @UserContext.CurrentPortfolioUser?.Name!</p>

        <div class="mb-3">
            @if (!isEditing)
            {
                <button class="btn btn-warning" @onclick="EnableEditing">✎ Edit Skills</button>
            }
            else
            {
                <button class="btn btn-success me-2" @onclick="SaveSkills">✔ Done</button>
                <button class="btn btn-secondary" @onclick="CancelEditing">✖ Cancel</button>
            }
        </div>

        <div class="skill-list">
            @if (isLoading)
            {
                <p>Loading skills...</p>
            }
            else if (!string.IsNullOrEmpty(errorMessage))
            {
                <p class="text-danger">@errorMessage</p>
                <button class="btn btn-primary" @onclick="LoadSkills">Retry</button>
            }
            else if (editableSkills != null && editableSkills.Any())
            {
                <ul class="list-unstyled">
                    @for (int i = 0; i < editableSkills.Count; i++)
                    {
                        <li class="mb-2">
                            @if (isEditing)
                            {
                                <input type="text" class="form-control d-inline w-auto" @bind="editableSkills[i]" />
                            }
                            else
                            {
                                @editableSkills[i]
                            }
                        </li>
                    }
                </ul>

                @if (isEditing)
                {
                    <div class="mt-3">
                        <input type="text" class="form-control d-inline w-auto me-2" placeholder="Add new skill..."
                               @bind="newSkill" />
                        <button class="btn btn-primary" @onclick="AddSkill">+ Add</button>
                    </div>
                }
            }
            else
            {
                <p>No skills found</p>

                @if (isEditing)
                {
                    <div class="mt-3">
                        <input type="text" class="form-control d-inline w-auto me-2" placeholder="Add your first skill..."
                               @bind="newSkill" />
                        <button class="btn btn-primary" @onclick="AddSkill">+ Add Skill</button>
                    </div>
                }
                else
                {
                    <button class="btn btn-outline-primary mt-2" @onclick="EnableEditing">Add your first skill</button>
                }
            }
        </div>
    </Authorized>
    <NotAuthorized>
        <p>Please log in to view this page.</p>
    </NotAuthorized>
</AuthorizeView>

@code {
    private List<string> editableSkills = new List<string>();
    private string? newSkill = string.Empty;
    private bool isEditing = false;
    private bool isLoading = true;
    private string? errorMessage;

    protected override void OnInitialized()
    {
        LoadSkillsFromUserContext();
    }

    private void LoadSkillsFromUserContext()
    {
        if (UserContext.CurrentPortfolioUser?.PortfolioUserSkills != null)
        {
            editableSkills = UserContext.CurrentPortfolioUser.PortfolioUserSkills.Select(s => s.Skill!.Name ?? string.Empty).ToList();
        }
        else
        {
            editableSkills = new List<string>();
        }

        isLoading = false;
        errorMessage = null;
    }

    private void EnableEditing()
    {
        isEditing = true;
        LoadSkillsFromUserContext();
        newSkill = string.Empty;
    }

    private void CancelEditing()
    {
        isEditing = false;
        LoadSkillsFromUserContext();
        newSkill = string.Empty;
        errorMessage = null;
    }

    private void AddSkill()
    {
        if (!string.IsNullOrWhiteSpace(newSkill))
        {
            editableSkills.Add(newSkill.Trim());
            newSkill = string.Empty;
        }
    }

    private async Task SaveSkills()
    {
        try
        {
            if (editableSkills != null)
            {
                bool result = await ApiClient.UpdateUserSkillsAsync(editableSkills);
                if (result)
                {
                    Logger.LogInformation("Skills updated successfully.");

                    // Update UserContext.CurrentUser.PortfolioUserSkills to reflect changes
                    UserContext.CurrentPortfolioUser!.PortfolioUserSkills = editableSkills
                        .Select(s => new PortfolioUserSkillDto { Skill = new SkillDto{Name = s, Level = "Beginner"} })
                        .ToList();

                    isEditing = false;
                    errorMessage = null;
                }
                else
                {
                    errorMessage = "Unable to update skills.";
                    Logger.LogError(errorMessage);
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving skills.");
            errorMessage = "Failed to save skills.";
        }
    }

    private async Task LoadSkills()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            IEnumerable<SkillDto>? response = await ApiClient.GetUserSkillsAsync();
            if (response != null)
            {
                // Map SkillDto -> PortfolioUserSkillDto so the UserContext keeps the expected shape
                UserContext.CurrentPortfolioUser!.PortfolioUserSkills = response
                    .Select(s => new PortfolioUserSkillDto
                    {
                        SkillId = s.Id,
                        PortfolioUserId = UserContext.CurrentPortfolioUser!.Id,
                        Skill = new SkillDto
                        {
                            Id = s.Id,
                            Name = s.Name,
                            Level = s.Level
                        }
                    })
                    .ToList();

                editableSkills = response.Select(s => s.Name ?? string.Empty).ToList();
            }
            else
            {
                editableSkills = new List<string>();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error fetching skills.");
            errorMessage = "Failed to load skills.";
        }
        finally
        {
            isLoading = false;
        }
    }
}