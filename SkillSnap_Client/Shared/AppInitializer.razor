@inject UserService UserService
@inject AuthenticationStateProvider AuthStateProvider
@inject ISkillSnapApiClient ApiClient
@inject NavigationManager Navigation
@inject UserContext UserContext
@inject ILogger<AppInitializer> Logger


@code {
    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        // Extract ApplicationUserId or portfolioUserId claim
        var portfolioIdClaim = user.FindFirst("portfolioUserId")?.Value;

        if (portfolioIdClaim is not null)
        {
            var profile = await ApiClient.GetUserProfileByIdAsync(portfolioIdClaim);

            if (profile != null)
            {
                UserContext.SetPortfolioUser(profile);
                return;
            }
        }

        // No portfolio user found â†’ redirect to creation page
        // Avoid redirect loop: do not navigate if already on the create page
        var relative = Navigation.ToBaseRelativePath(Navigation.Uri).TrimEnd('/');
        if (string.Equals(relative, "profile/create", StringComparison.OrdinalIgnoreCase) ||
            string.Equals(relative, "profile/create/", StringComparison.OrdinalIgnoreCase))
        {
            Logger?.LogDebug("Already on /profile/create, skipping redirect to avoid loop.");
            return;
        }

        Logger?.LogInformation("No portfolio profile found for user; navigating to /profile/create.");
        Navigation.NavigateTo("/profile/create");
    }
}